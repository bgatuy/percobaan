<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <title>Form Tanda Terima CM</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.10.377/pdf.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      text-align: center;
      padding: 20px;
      background-color: #fff;
      color: #000;
    }

    .container {
      max-width: 800px;
      margin: auto;
    }

    h1 {
      font-size: 28px;
      font-weight: bold;
      margin-bottom: 20px;
    }

    .form-control {
      margin: 10px 0;
    }

    input[type="file"] {
      display: none;
    }

    label.upload-label {
      background-color: #007bff;
      color: white;
      padding: 10px 20px;
      cursor: pointer;
      border-radius: 6px;
    }

    .button-group button {
      padding: 10px 16px;
      margin: 5px;
      font-size: 16px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      background-color: #007bff;
      color: white;
    }

    .button-group button:hover {
      background-color: #0056b3;
    }

    .table-container {
      margin-top: 40px;
      overflow-x: auto;
    }

    table {
      border-collapse: collapse;
      width: 100%;
      margin: auto;
      font-size: 14px;
    }

    th, td {
      border: 1px solid #000;
      padding: 8px;
      text-align: center;
    }

    th {
      text-transform: uppercase;
      font-size: 14px;
    }

    .sign-table td {
      height: 80px;
    }

    @media (prefers-color-scheme: dark) {
      body {
        background-color: #fff;
        color: #000;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Form Tanda Terima CM</h1>

    <div class="form-control">
      <label for="tanggalSerah">Tanggal Serah Terima:</label>
      <input type="date" id="tanggalSerah">
    </div>

    <div class="form-control">
      <label for="multiPdf" class="upload-label">ðŸ“„ Pilih File PDF</label>
      <input type="file" id="multiPdf" multiple>
      <span id="jumlahFile">0 file dipilih</span>
    </div>

    <div class="button-group">
      <button onclick="prosesFile()">Proses</button>
      <button onclick="downloadPDF()">Download PDF</button>
    </div>

    <div class="table-container">
      <div id="tabelHasil"></div>
    </div>
  </div>

  <script>
    let dataTabel = [];

    function extractFromPDFText(text) {
      const lines = text.split('\n').map(line => line.trim()).filter(Boolean);
      let namaUker = "";

      const ukerLine = lines.find(line => /unit\s*kerja\s*[:\-]/i.test(line));
      if (ukerLine) {
        const match = ukerLine.match(/unit\s*kerja\s*[:\-]\s*(.*)/i);
        if (match && match[1]) {
          namaUker = match[1].replace(/^[:\s]+/, '').trim();
        }
      }

      if (!namaUker) {
        const index = lines.findIndex(line => /unit\s*kerja/i.test(line));
        if (index !== -1) {
          const collected = [];
          for (let i = index + 1; i < lines.length; i++) {
            const line = lines[i];
            if (/^(tanggal|pelapor|jenis perangkat|asset id|kantor cabang)/i.test(line)) break;
            if (line && !/unit\s*kerja/i.test(line)) collected.push(line);
          }
          if (collected.length) {
            namaUker = collected.join(' ').replace(/^[:\s]+/, '').trim();
          }
        }
      }

      if (!namaUker) {
        const keywordIndex = lines.findIndex(line =>
          /(BRI|ENTERPRISE|SYNDICATION|MANAGEMENT|LOGISTIC|CORPORATE|ACCOUNTING|TRANSFORMATION|PROCUREMENT)/i.test(line)
        );
        if (keywordIndex !== -1) {
          const collected = [];
          for (let i = keywordIndex; i < lines.length; i++) {
            const line = lines[i];
            if (/^(tanggal|pelapor|jenis perangkat|asset id|kantor cabang)/i.test(line)) break;
            collected.push(line);
          }
          if (collected.length) {
            namaUker = collected.join(' ').replace(/^[:\s]+/, '').trim();
          }
        }
      }

      if (!namaUker) namaUker = "Tidak ditemukan";

      const tanggalTiketMatch = text.match(/Tanggal.*?:\s*(\d{2}[\/\-]\d{2}[\/\-]\d{4})/i);
      const tanggalPekerjaan = tanggalTiketMatch ? tanggalTiketMatch[1] : "Tidak ditemukan";

      return { namaUker, tanggalPekerjaan };
    }

    async function prosesFile() {
      const input = document.getElementById('multiPdf');
      const files = input.files;
      const tanggalSerah = document.getElementById('tanggalSerah').value;
      if (!files.length || !tanggalSerah) return alert("Isi tanggal dan upload PDF");

      const [y, m, d] = tanggalSerah.split("-");
      const tglSerahFormatted = `${d}/${m}/${y}`;
      dataTabel = [];

      for (let i = 0; i < files.length; i++) {
        const arrayBuffer = await files[i].arrayBuffer();
        const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
        let fullText = "";
        for (let j = 1; j <= pdf.numPages; j++) {
          const page = await pdf.getPage(j);
          const content = await page.getTextContent();
          fullText += content.items.map(item => item.str).join('\n');
        }

        const { namaUker, tanggalPekerjaan } = extractFromPDFText(fullText);
        dataTabel.push({
          no: i + 1,
          tanggalSerah: tglSerahFormatted,
          namaUker,
          tanggalPekerjaan
        });
      }

      tampilkanTabel();
      document.getElementById("jumlahFile").textContent = `${files.length} file dipilih`;
    }

    function tampilkanTabel() {
      const tableHTML = `
      <h2>FORM TANDA TERIMA CM</h2>
      <table>
        <thead>
          <tr>
            <th>NO.</th>
            <th>TANGGAL SERAH TERIMA</th>
            <th>NAMA UKER</th>
            <th>TANGGAL PEKERJAAN</th>
          </tr>
        </thead>
        <tbody>
          ${dataTabel.map(row => `
            <tr>
              <td>${row.no}</td>
              <td>${row.tanggalSerah}</td>
              <td>${row.namaUker}</td>
              <td>${row.tanggalPekerjaan}</td>
            </tr>
          `).join("")}
        </tbody>
      </table>
      <br>
      <table class="sign-table">
        <tr>
          <th>TTD TEKNISI</th>
          <th>TTD LEADER</th>
          <th>TTD CALL CENTER</th>
        </tr>
        <tr>
          <td></td><td></td><td></td>
        </tr>
      </table>`;
      document.getElementById('tabelHasil').innerHTML = tableHTML;
    }

    async function downloadPDF() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF({ unit: 'pt', format: 'a4' });
      const margin = 40;
      const pageWidth = doc.internal.pageSize.getWidth();
      const usableWidth = pageWidth - 2 * margin;

      const colWidths = [40, 120, 270, 120]; // total = 550
      const header = ["NO.", "TANGGAL SERAH TERIMA", "NAMA UKER", "TANGGAL PEKERJAAN"];

      let y = 60;
      doc.setFont("Helvetica", "bold");
      doc.setFontSize(18);
      doc.text("FORM TANDA TERIMA CM", pageWidth / 2, y, { align: 'center' });

      y += 30;
      doc.setFontSize(12);
      let x = margin;
      for (let i = 0; i < header.length; i++) {
        doc.text(header[i], x + 2, y);
        x += colWidths[i];
      }

      doc.setFont("Helvetica", "normal");
      dataTabel.forEach(row => {
        const values = [String(row.no), row.tanggalSerah, row.namaUker, row.tanggalPekerjaan];
        x = margin;
        y += 18;
        for (let i = 0; i < values.length; i++) {
          doc.text(values[i], x + 2, y);
          x += colWidths[i];
        }
      });

      y += 40;
      const signHeaders = ["TTD TEKNISI", "TTD LEADER", "TTD CALL CENTER"];
      const boxWidth = (usableWidth - 2) / 3;
      const boxHeight = 80;
      x = margin;

      doc.setFont("Helvetica", "bold");
      for (let i = 0; i < signHeaders.length; i++) {
        doc.text(signHeaders[i], x + boxWidth / 2, y, { align: 'center' });
        x += boxWidth;
      }

      y += 10;
      x = margin;
      for (let i = 0; i < 3; i++) {
        doc.rect(x, y, boxWidth, boxHeight);
        x += boxWidth;
      }

      doc.save("Tanda_Terima_CM.pdf");
    }
  </script>
</body>
</html>
